#!/usr/bin/env php
<?php
if (!defined('DS')) { define('DS', DIRECTORY_SEPARATOR); }

// make sure we never run out of time.
set_time_limit(0);

/**
 *---------------------------------------------------------------
 * Bootstrap
 *---------------------------------------------------------------
 *
 * We need what we need
 */
$queue = require __DIR__ . DS . '..' . DS . 'bootstrap.php';

use Symfony\Component\Process\Process;

$maxWorkers = 64;
$workerSlots = [];

while($job = $queue->getNextJob())
{
	usleep(10000);

	// check the worker status
	foreach($workerSlots as $i => $process) {
		if (!$process->isRunning()) {
			unset($workerSlots[$i]);
		}
	}

	if (count($workerSlots) >= $maxWorkers) {
		continue;
	}

	$process = new Process('php ' . __DIR__ . '/worker');
	$process->start();

	$workerSlots[] = $process;
}